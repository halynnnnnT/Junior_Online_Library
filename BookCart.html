<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Borrowing Book's Cart System</title>
  <link href="statics/css/bootstrap.min.css" rel="stylesheet">
  <link href="statics/css/font-awesome.min.css" rel="stylesheet">
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
  <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon">

	<link href="statics/css/product.css" rel="stylesheet">
  <link href="statics/css/jquery-confirm.css" rel="stylesheet">


  <script src="statics/js/jquery-3.4.1.min.js"></script>
  <script src="statics/js/jquery-confirm.js"></script>

  <meta name='viewport' content='width=device-width, initial-scale=1'>
<script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

<style>
nav {
  display: block;
  text-align: ;
}
nav ul {
  margin: 0;
  padding:0;
  list-style: none;
}
.nav a {
  display:block;
  background: #000;
  color: #fff;
  text-decoration: none;
  padding: 0.8em 1.8em;
  text-transform: uppercase;
  font-size: 100%;
  letter-spacing: 1px;
  text-shadow: 0 -1px 0 #000;
  position: relative;
}
.nav{
  vertical-align: top;
  display: inline-block;
  box-shadow:
    1px -1px -1px 1px #000,
    -1px 1px -1px 1px #fff,
    0 0 6px 3px #68a3bf;
  border-radius:6px;
  margin-top: 10px;
}
.nav li {
  position: relative;
}
.nav > li {
  float: left;
  border-bottom: 4px #aaa solid;
  margin-right: 1px;
}
.nav > li > a {
  margin-bottom: 1px;
  box-shadow: inset 0 2em .33em -0.5em black;
}
.nav > li:hover,
.nav > li:hover > a {
  border-bottom-color: #68a3bf;
}
.nav li:hover > a {
  color:#68a3bf;
}
.nav > li:first-child {
  border-radius: 4px 0 0 4px;
}
.nav > li:first-child > a {
  border-radius: 4px 0 0 0;
}
.nav > li:last-child {
  border-radius: 0 0 4px 0;
  margin-right: 0;
}
.nav > li:last-child > a {
  border-radius: 0 4px 0 0;
}
.nav li li a {
  margin-top: 1px;
}

.nav li a:first-child:nth-last-child(2):before {
  content: "";
  position: absolute;
  height: 0;
  width: 0;
  border: 5px solid transparent;
  top: 50% ;
  right:5px;
 }

 .nav ul {
  position: absolute;
  white-space: nowrap;
  border-bottom: 5px solid  #68a3bf;
  z-index: 1;
  left: -99999em;
}
.nav > li:hover > ul {
  left: auto;
  margin-top: 5px;
  min-width: 100%;
}
.nav > li li:hover > ul {
  left: 100%;
  margin-left: 1px;
  top: -1px;
}
/* arrow hover styling */
.nav > li > a:first-child:nth-last-child(2):before {
  border-top-color: #aaa;
}
.nav > li:hover > a:first-child:nth-last-child(2):before {
  border: 5px solid transparent;
  border-bottom-color: #68a3bf;
  margin-top:-5px
}
.nav li li > a:first-child:nth-last-child(2):before {
  border-left-color: #aaa;
  margin-top: -5px
}
.nav li li:hover > a:first-child:nth-last-child(2):before {
  border: 5px solid transparent;
  border-right-color: #68a3bf;
  right: 10px;
}

.header{
	background-color: #E0E0E0;
	height: 180px;
	background-image : url("https://www.madagascarislandsafaris.co.za/wp-content/uploads/2017/08/Travel-Blog-Header-1600x400.jpg");
	background-size : 100%;

}

.title-header{
	padding-top: 12px;
	font-size: 50px;
	font-family: 'Courier New', monospace;
	font-weight: bold;
	margin-left: 40px;
}

h1{
 font-size: 36px;
 margin-left: 50px;
 font-family: Marker Felt, fantasy;
  letter-spacing: 5px;
  text-shadow: 2px 2px 0 #fff, 5px 5px 0 #dfe8f1;

  color: #33342e;
}
#submit{
  float:right;
  font-family:Verdana, sans-serif;
  margin-top: 10px;
}
</style>

</head>

<body style =" background-color : #F8F8FF">
    <div class = "header">
	<p class = "title-header" >Library Management System </p>
	<p class = "mytitle-header"><a class = "mytitle-header" href = "Member.html" style = 'padding-left: 40px; color: black;'><i class='fas fa-share-square' style='font-size:24px'>Back to Home page</i></a></p>
</div>

<nav >
   <ul class="nav">
    <li><a href="#">Search</a>
      <ul>
        <li><a href="BookCatalogCategory3.html">Books by Categories</a></li>
        <li><a href="BookCatalogSearch3.html">Books by Search</a></li>
        <li><a href="DVDCatalogGenre3.html">DVDs by Genres</a></li>
        <li><a href="DVDCatalogSearch3.html">DVDs by Search</a></li>
        <li><a href="ThesisCatalogMajor3.html">Thesis by Major</a></li>
        <li><a href="ThesisCatalogSearch3.html">Thesis by Search</a></li>
      </ul>
    </li>
    <li><a href="#">Borrow</a>
      <ul>
        <li><a href="BorrowBookCatalog.html">Books</a></li>
        <li><a href="#">DVDs</a></li>
        <li><a href="#">Thesis</a></li>
      </ul>
    </li>

    <li><a href="Customer.html">Logout</a>
    </li>

  </ul>
</nav>

  <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center bg-light">
    <h1 class="display-4">Borrowing Book's Cart System</h1>
    <p class="lead">" If you don't find a good teacher, find a good book "</p>
  </div>

  <div class="container">
	  <div class="py-5">
	  	<div class='row'>
		  	<div class="col-md-4 order-md-2 mb-4">
		      <h4 class="d-flex justify-content-between align-items-center mb-3">
		        <span class="text-muted">Book's Cart Summary</span>
		        <span id="date" class="badge badge-secondary badge-pill">YYYY/MM/DD</span>
		      </h4>
		      <ul class="list-group mb-3">
		        <li class="list-group-item d-flex justify-content-between lh-condensed">
		          <div>
		            <h6 class="my-0">Book's Title Quantity</h6>
		          </div>
		          <span id="total_item" class="text-muted">0</span>
		        </li>
		        <li class="list-group-item d-flex justify-content-between bg-light">
		          <div class="text-success">
		            <h6 class="my-0">Total Book's Quantity</h6>
		          </div>
		          <span id="total_quantity" class="text-success">0</span>
		        </li>
		      </ul>
		      <button id="check" class="btn btn-primary btn-lg btn-block" type="button">Borrow Now</button>
		      <button id="clean" class="btn btn-dark btn-lg btn-block" type="button">Clear Cart</button>
		    </div>

		    <div class="col-md-8 order-md-1">
		      <h4 class="mb-3">Reciept's Personal Information</h4>
		      <hr class="mb-4">
	        <div class="row">
	          <div class="col-md-6 mb-2">
	            <label for="lastName">Family Name</label>
	            <input type="text" class="form-control" id="last_name" maxlength="15" value="" required>
	          </div>

	          <div class="col-md-6 mb-4">
	            <label for="firstName">Given Name</label>
	            <input type="text" class="form-control" id="first_name" maxlength="15" placeholder="" value="" required>
	          </div>
	        </div>

	        <div class="mb-3">
	          <label for="email">Email </label>
	          <input type="email" class="form-control" maxlength="50" id="email" placeholder="you@example.com" required>
	        </div>

	        <div class="mb-3">
	          <label for="phonenum">Reciept's Phone Number</label><br/>
	          <input id="phone" type="tel" class="form-control" maxlength="10" placeholder="Please input Taiwan Phone Number, ex: 09xxxxxxxx" required>
	        </div>

	        <div class="mb-3">
                <label for="librarydelivery">Book's Pickup Mode</label>
                	<select name="librarydelivery" id="librarydelivery">
                		<option value = "delivery">Delivery Service</option>
                		<option value = "personal">Personal Pickup</option>
                	</select>
            </div>

	        <div class="mb-3">
	          <label for="address">Receipt's Home Address</label>
	          <input type="text" class="form-control" id="address" maxlength="255" placeholder="Please input Taiwan Home/Office Address" required>
	        </div>

	        <h4 class="mb-3">Currently Borrowed Book's Cart</h4>
	        <hr class="mb-4">
	        <div class="row">
				    <div class="table-responsive">
			        <table id="cart_table" class="table table-striped table-sm">
			          <thead>
			            <tr>
			              <th class="text-center" style="width: 10%">Book Id</th>
			              <th class="text-center" style="width: 25%">Title</th>
			              <th class="text-center" style="width: 20%">Author</th>
			              <th class="text-center" style="width: 15%">Publisher</th>
			              <th class="text-center" style="width: 10%">Quantity</th>
			              <th class="text-center" style="width: 10%">Delete</th>
			            </tr>
			          </thead>
			          <tbody>
			          </tbody>
			        </table>
			      </div>
		      </div>

	      </div>
      </div>
	  </div>
  </div>

  <script>
    var [client_cart_obj, client_cart_amount]  = getCartDataFromClient();

    if (client_cart_obj.length == 0) {
    	alert("There are no books in the book's cart...");
    	calcSummaryInformation();
    	setButtonState("check", false);
    }
    else
    	getCartProduct();

    $("#check").click(function () {
    	var data = {
    			"first_name": $("#first_name").val(),
    			"last_name": $("#last_name").val(),
    			"email": $("#email").val(),
    			"phone": $("#phone").val(),
    			"bookDelivery": $("#librarydelivery option:selected").val(),
    			"address": $("#address").val(),
    			"item": client_cart_obj,
    			"quantity": client_cart_amount
    	}

    	pass_vaild = vaildData(data);
    	if (pass_vaild) {
    		var data_string = JSON.stringify(data);

        $.ajax({
          type: "POST",
          url: "api/order.do",
          data: data_string,
          crossDomain: true,
          cache: false,
          dataType: 'json',
          timeout: 5000,
          success: function (response) {
              if(response.status == 200){
              	$.confirm({
                    theme: 'modern',
                    icon: 'fa fa-check-circle-o',
                    type: 'green',
                    animation: 'scale',
                    title: 'System Reminder',
                    content: "All the books in the list has successfully borrowed",
                    buttons: {
                        confirm: {
                            text: 'confirm',
                            btnClass: 'btn-blue',
                            action: function () {
                          	  cleanAllData();
                              document.location.href = "Member.html";
                            }
                        }
                    }
                });
              }
          },
          error: function () {
              alert("Cannot connect to server");
          }
        });
    	}
    });

    $("#clean").click(function () {
    	console.log("[@Action]清空購物車");
    	cleanAllData();
    });

    function vaildData(data) {
    	var telpnum_rule = /((?=(09))[0-9]{10})$/g;
    	var email_rule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;

    	if (data["first_name"] == "" || data["last_name"] == "" || data['phone'] == "" || data['address'] == "" || data['email'] == "")  alert("The required fields must not have empty values...");
    	else if (!telpnum_rule.test(data['phone'])) alert("Error, must use Taiwan's Phone Number Format...");
    	else if(data['email'] != "" && !email_rule.test(data['email'])) alert("Email formal error.....");
    	else return true;

    	return false;
    }

    function cleanAllData() {
    	client_cart_obj = [];
      client_cart_amount = [];
      updateCartDataToClent();
      $("#cart_table > tbody").empty();
      $("#total_item").html('0');
      $("#total_quantity").html('0');
      $("#summary").html('0');
      setButtonState("check", false);
    }

    function getCartProduct() {
      $.ajax({
        type: "GET",
        url: "api/borrow.do",
        crossDomain: true,
        cache: false,
        data: "id_list=" + client_cart_obj.toString(),
        dataType: 'json',
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
        	  updateCartTable(response.response.data);
        	  updateAllQuantitySubtotal();
        	  keyEventListen();
        	  calcSummaryInformation();
          }
        },
        error: function () {
          alert("Cannot Connect to Server");
        }
      });
    }

    function updateAllQuantitySubtotal() {
    	for (var i=0 ; i < client_cart_obj.length ; i++) {
    		var id = client_cart_obj[i];
    		var amount = client_cart_amount[i];
    		var price = $('#price_' + id).html();
    		$('#quantity_' + id).val(amount);
    		var subtotal = calcSubTotal(price, amount);
    		$('#subtotal_' + id).html(subtotal);
    	}
    }

    function isNumberKey(evt){
	    var charCode = (evt.which) ? evt.which : evt.keyCode
	    if (charCode > 31 && (charCode < 48 || charCode > 57))
	        return false;
	    return true;
    }

    function keyEventListen() {
    	$('input[name="quantity[]"').on(
          'keypress',
          function (e) {
        	  return isNumberKey(e);
          }
      );

    	$('input[name="quantity[]"').on(
 	        'keyup',
 	        function (e) {
 	        	var select = $(this).prop('id');
 	        	var action = select.split('_')[0];
 	        	var id = select.split('_')[1];
 	            var quantity =  $(this).val();
 	          	updateClentCartData(id, quantity);
 	          	calcSummaryInformation();
 	        }
 	    );

    	$('button[name="remove[]"').click(function () {
    		var id = (this.id).split('_')[1];
    		var i = client_cart_obj.indexOf(id);

    		if (i > -1) {
	    		client_cart_obj.splice(i, 1);
	    		client_cart_amount.splice(i, 1);
    		}

    		updateCartDataToClent();
    		$('#row_' + id).remove();
    		if (client_cart_obj.length == 0)
  		      alert("There are no books in the book's cart...");
    		calcSummaryInformation();
    	});


    }

    function calcSubTotal(price, quantity) {
    	var result = (parseFloat(price) * parseFloat(quantity)).toFixed(2);
    	result = isNaN(result) ? 0.00 : result;
    	return result;
    }

    function updateCartTable(data) {
    	table_html = '';
    	$("#cart_table > tbody").empty();
        $.each(data, function(index, value) {

        	table_html += '<tr id="row_' + value.id + '">';
        	table_html += '<td class="align-middle text-center">' + value.id + '</td>';
        	table_html += '<td class="align-middle"><p class="text-break">' + value.title + '</p></td>';
        	table_html += '<td class="align-middle"><p class="text-break">' + value.author + '</p></td>';
        	table_html += '<td class="align-middle"><p class="text-break">' + value.publisher + '</p></td>';
        	table_html += '<td class="align-middle text-center"><input type="input" name="quantity[]" class="input-sm form-control text-center" id="quantity_' + value.id + '" maxlength="5" min="0" step="1"></td>';
        	table_html += '<td class="align-middle text-center"><button id="remove_' + value.id + '" name="remove[]" type="button" class="btn btn-danger">Delete</button></td>';
        	table_html += '</tr>';

        })

      $("#cart_table > tbody").append(table_html);
    }

    function getCartDataFromClient() {
    	let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
    	let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
    	cart = !cart ? new Array() : cart;
    	amount = !amount ? new Array() : amount;
    	return [cart, amount];
    }

    function updateCartDataToClent() {
    	localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
    	localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
    }

    function updateClentCartData(id, quantity) {
    	var i = client_cart_obj.indexOf(id);
    	client_cart_amount[i] = (quantity === "") ? 0 : parseInt(quantity);
    	updateCartDataToClent();
    }

    function calcSummaryInformation() {
    	var total_item = client_cart_obj.length;
    	var total_price = 0.00;
    	var total_quantity = 0;

    	for(var i=0 ; i < total_item ; i++) {
    		var id = client_cart_obj[i];
    		var price = $('#price_' + id).html();
    		var quantity = $('#quantity_' + id).val()
    		calc = parseFloat(price) * parseInt(quantity);
    		total_price += isNaN(calc) ? 0.0 : calc;
    		total_quantity += (isNaN(quantity) || (quantity == "")) ? 0 : parseInt(quantity);
    	}

    	var date = new Date();
    	var iso_date = date.toISOString();

    	$("#date").html(iso_date.substring(0, 10));
    	$("#total_item").html(total_item);
    	$("#total_quantity").html(total_quantity);
    	$("#summary").html(total_price.toFixed(2));
    }

    function setButtonState(id, action) {
      if (!action) {
          $('#' + id).prop('disabled', true);
          $('#' + id).addClass('disabled');
          $('#' + id).html('Please Select Book First');
      }
      else {
    	  $('#' + id).prop('disabled', false);
        $('#' + id).removeClass('disabled');
        $('#' + id).html('Borrow Now');
      }
    }
  </script>
</body>


</html>
